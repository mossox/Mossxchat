<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <title>Mossso X Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            font-family: Arial;
            background: #0f1219;
            margin: 0;
            padding: 20px;
            color: rgb(255, 238, 0);
            text-shadow: 0 0 5px #0ff, 0 0 10px rgba(0, 255, 255, 0), 0 0 20px rgba(0, 255, 255, 0), 0 0 40px rgb(10, 10, 10);
        }

        .container {
            max-width: 500px;
            margin: auto;
            background: #111622;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            border: 1px solid #0ff;
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 30px #0ff;
            }

            to {
                box-shadow: 0 0 20px #0ff, 0 0 30px #0ff, 0 0 40px #0ff;
            }
        }


        h2,
        h3,
        h4 {
            text-align: center;
            color: #00ff62;
            text-shadow: 0 0 5px #00ff62, 0 0 10px #00ff62;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #0ff;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #0ff;
            border-radius: 4px;
            background: #0d101a;
            color: #00ff62;
            box-shadow: 0 0 5px #0ff;
        }

        button {
            background: #00FFFF;
            /* Biru Neon */
            color: #0d101a;
            /* Teks gelap agar kontras */
            padding: 10px 15px;
            border: none;
            border-radius: 44px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
            box-shadow: 0 0 8px #00FFFF, 0 0 15px #00FFFF;
            /* Efek glow */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        button:hover {
            background: #00E6E6;
            /* Sedikit lebih gelap saat hover */
            box-shadow: 0 0 12px #00E6E6, 0 0 20px #00E6E6, 0 0 30px #00E6E6;
            /* Glow lebih kuat saat hover */
        }

        .tab-button {
            background: #00BFFF;
            /* Biru Langit (untuk variasi) */
            color: #0d101a;
            /* Teks gelap agar kontras */
            border: 1px solid #00BFFF;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 0 5px #00BFFF;
            /* Efek glow awal */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .tab-button:hover {
            background: #00AADD;
            /* Sedikit lebih gelap saat hover */
            box-shadow: 0 0 10px #00AADD, 0 0 15px #00AADD;
            /* Glow lebih kuat saat hover */
        }

        .tab-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        #dashboard {
            margin-top: 20px;
        }

        .info-box,
        .chat-box,
        .history-box,
        .withdraw-box,
        .voucher-box,
        .downline-box {
            background: #1a2233;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #0ff;
        }

        .info-box p,
        .history-box div,
        .withdraw-box div,
        .voucher-box p,
        .downline-box div {
            margin: 5px 0;
            color: rgb(255, 238, 0);
            /* Changed to yellow */
        }

        .chat-box {
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 10px;
            border: 1px solid #0ff;
            background: #0d101a;
            padding: 10px;
            border-radius: 6px;
        }

        /* Container for each message, including username and bubble */
        .message-wrapper {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .chat-message {
            padding: 8px 12px;
            border-radius: 15px;
            /* Rounded corners for the bubble */
            max-width: 70%;
            /* Limit bubble width */
            word-wrap: break-word;
            /* Break long words */
            position: relative;
            /* Needed for positioning username if you wanted it absolutely */
        }

        .username-label {
            font-weight: bold;
            font-size: 0.85em;
            /* Slightly smaller username */
            margin-bottom: 3px;
            /* Space between username and bubble */
        }

        .message-wrapper.self {
            align-items: flex-end;
            /* Align self messages to the right */
        }

        .message-wrapper.other {
            align-items: flex-start;
            /* Align other messages to the left */
        }

        .message-wrapper.self .username-label {
            color: #00e650;
            /* Greenish for self username */
            margin-right: 5px;
            /* Slight indent from the right for self username */
        }

        .message-wrapper.other .username-label {
            color: #ffcc00;
            /* Yellowish for other username */
            margin-left: 5px;
            /* Slight indent from the left for other username */
        }

        .chat-message.self-bubble {
            background-color: #007bff;
            /* Blue for self messages */
            color: white;
            margin-right: 5px;
            /* Adjust margin to align with username */
        }

        .chat-message.other-bubble {
            background-color: #ffc107;
            /* Yellow for other messages */
            color: #333;
            /* Darker text for readability on yellow */
            margin-left: 5px;
            /* Adjust margin to align with username */
        }

        /* New CSS for input and button alignment */
        .chat-input-area {
            display: flex;
            margin-bottom: 10px;
            /* Space below the input/button area */
            gap: 5px;
            /* Space between input and button */
        }

        #messageInput {
            flex-grow: 1;
            /* Allows input to take up available space */
            margin-bottom: 0;
            /* Remove existing bottom margin */
        }

        #sendMessageBtn {
            width: auto;
            /* Allow button to size based on content */
            padding: 10px 15px;
            /* Adjust padding for button */
            margin-bottom: 0;
            /* Remove existing bottom margin */
        }

        .list-item {
            border-bottom: 1px dashed #0ff;
            padding: 8px 0;
            color: rgb(255, 238, 0);
            /* Changed to yellow */
        }

        .list-item:last-child {
            border-bottom: none;
        }

        #referralStatus {
            font-weight: bold;
        }

        .warning-message {
            color: red;
            background-color: #331f1f;
            border: 1px solid red;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        .blink-warning {
            animation: blinker 1s linear infinite;
            color: orange;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }

        .blink-warning.success {
            color: #00ff62;
            animation: none;
        }

        /* Admin Panel Specific Styles */
        .admin-box {
            background: #111622;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 0 8px #0ff;
        }

        #adminDashboard {
            display: none;
            /* Hidden by default */
        }

        .admin-box h3 {
            font-size: 1.2em;
        }

        .admin-box input[type="text"],
        .admin-box select,
        .admin-box textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 10px;
            box-sizing: border-box;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            background: #00121a;
            color: #0ff;
            text-shadow: none;
            box-shadow: 0 0 8px #0ff inset;
        }

        .admin-box textarea {
            resize: vertical;
        }

        .admin-box button {
            background: #00ffff;
            color: #001f27;
            cursor: pointer;
            font-weight: bold;
            border: none;
            box-shadow: 0 0 15px #00ffff;
            transition: background 0.3s ease;
        }

        .admin-box button:hover {
            background: #33ffff;
            box-shadow: 0 0 25px #33ffff;
        }

        .admin-box table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
            color: #0ff;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }

        .admin-box th,
        .admin-box td {
            border: 1px solid #033;
            padding: 6px;
            text-align: left;
        }

        .admin-box th {
            background-color: #00222a;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
        }

        .admin-box tr:nth-child(even) {
            background-color: #01161d;
        }

        .admin-box tr:hover {
            background-color: #00303a;
        }

        .message-success {
            color: lightgreen;
            text-shadow: 0 0 5px lightgreen;
        }

        .message-error {
            color: red;
            text-shadow: 0 0 5px rgb(255, 251, 0);
        }

        #adminPanelLink {
            display: none; /* Hidden by default for non-admins */
            margin-top: 15px;
        }

        /* Tambahan untuk downline list dan bonus */
        .downline-list-container li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #334455;
        }

        .downline-list-container li:last-child {
            border-bottom: none;
        }

        .downline-info {
            flex-grow: 1; /* Biarkan info downline mengambil ruang yang tersedia */
        }

        .downline-bonus {
            flex-shrink: 0; /* Hindari bonus menyusut */
            text-align: right;
            font-weight: bold;
            color: #ffcc00; /* Warna untuk bonus */
        }

        .view-level2-link {
            color: #0ff;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 10px;
            white-space: nowrap; /* Pastikan link tidak pecah baris */
        }

        /* CSS untuk Pop-up Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }

        .modal-content {
            background-color: #111622;
            margin: auto;
            padding: 20px;
            border: 1px solid #0ff;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 15px rgba(0,255,255,0.7);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content ul {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-content ul li {
            display: flex; /* Gunakan flexbox untuk item di modal juga */
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #334455;
        }
        .modal-content ul li:last-child {
            border-bottom: none;
        }

        /* Styles for Withdrawal Modal */
        #withdrawModalContent {
            display: none; /* Hidden by default */
        }

        .withdraw-box button {
            margin-top: 10px;
        }

        /* New styles for side-by-side buttons */
        .dashboard-buttons-container {
            display: flex;
            justify-content: space-between; /* Distribute space evenly */
            gap: 10px; /* Space between buttons */
            margin-bottom: 20px;
        }

        .dashboard-buttons-container button {
            flex-grow: 1; /* Allow buttons to grow and fill space */
            width: auto; /* Override default 100% width */
            margin-bottom: 0; /* Remove bottom margin if any */
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="userInterface">
            <div id="loginSection">
                <h2>Login</h2>
                <div class="tab-container">
                    <button class="tab-button" onclick="toggleView('login')">Login</button>
                    <button class="tab-button" onclick="toggleView('register')">Register</button>
                </div>
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" placeholder="Masukkan email Anda" />
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" placeholder="Masukkan password Anda" />
                <button onclick="login()">Login</button>
            </div>

            <div id="registerSection" style="display: none">
                <h2>Register</h2>
                <div class="tab-container">
                    <button class="tab-button" onclick="toggleView('login')">Login</button>
                    <button class="tab-button" onclick="toggleView('register')">Register</button>
                </div>
                <label for="regEmail">Email:</label>
                <input type="email" id="regEmail" placeholder="Masukkan email Anda" />
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" placeholder="Buat password" />
                <label for="regUsername">Username (Kode Referral Anda):</label>
                <input type="text" id="regUsername" placeholder="Buat username unik" />
                <label for="regRefCode">Kode Referral Upline (opsional):</label>
                <input type="text" id="regRefCode" placeholder="Jika ada" />
                <button onclick="register()">Register</button>
            </div>

            <div id="dashboard" style="display: none">
                <h3>Selamat Datang, <span id="usernameDisplay"></span>! 👋</h3>
                <h4><p>Mulai Obrolan untuk farming Mosso X</p></h4>
                <p>Email: <span id="userEmail"></span></p>
                <p>Mosso X Anda: <span id="myPoints">0</span></p>
                <p>Status Referral: <span id="referralStatus">BELUM AKTIF</span></p>

                <div id="referralStatusWarning" class="warning-message blink-warning" style="display: none;">
                    ⚠️ Status referral Anda belum aktif. Masukkan voucher
                    untuk mulai menerima bonus dari downline dan melakukan penarikan!
                </div>

                <button id="adminPanelLink" class="tab-button" onclick="showAdminPanel()">Admin Panel</button>

                <div class="chat-box">
                    <h4>Chat Global</h4>
                    <div id="chatBox">
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="messageInput" placeholder="Ketik pesan Anda..." />
                    <button id="sendMessageBtn" onclick="sendMessage()">Kirim</button>
                </div>

                <div class="voucher-box">
                    <h4>Aktifkan Bonus Referral</h4>
                    <label for="voucherCode">Kode Voucher:</label>
                    <input type="text" id="voucherCode" placeholder="Masukkan kode voucher" />
                    <button onclick="useVoucher()">Gunakan Voucher</button>
                    <p id="voucherMessage" class="warning-message" style="display: none;"></p>
                </div>

                <div class="dashboard-buttons-container">
                    <button onclick="showDownlineModal()">Jaringan Downline</button>
                    <button onclick="showBonusHistoryModal()">Riwayat Bonus</button>
                </div>

                <div class="withdraw-box">
                    <h4>Penarikan Mosso X</h4>
                    <button onclick="showWithdrawalModal()">Ajukan Penarikan</button>
                    <div id="withdrawModalContent">
                        <label for="withdrawName">Nama Anda:</label>
                        <input type="text" id="withdrawName" placeholder="Masukkan nama Anda" />
                        <label for="withdrawUser">Username Anda:</label>
                        <input type="text" id="withdrawUser" placeholder="Masukkan username Anda" />
                        <label for="withdrawWallet">Alamat Wallet Mosso X :</label>
                        <input type="text" id="withdrawWallet" placeholder="Masukkan nomor wallet Anda" />
                        <label for="withdrawAmount">Jumlah Penarikan (min 50 Mosso X):</label>
                        <input type="number" id="withdrawAmount" placeholder="Jumlah Mosso X" step="0.00001" />
                        <label for="withdrawVoucher">Kode Voucher Penarikan:</label>
                        <input type="text" id="withdrawVoucher" placeholder="Masukkan kode voucher penarikan" />
                        <button onclick="requestWithdraw()">Konfirmasi Penarikan</button>
                        <p>⚠️Pastikan Alamat Wallet Penarikan Benar, Kerna Bersifat Final dan tidak Bisa diBatalkan⚠️ </p>
                        <p id="withdrawWarning" class="warning-message blink-warning" style="display: none;"></p>
                    </div>
                </div>


                <button onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="adminPanelSection" class="container" style="display: none;">
            <div id="adminLoginSection" class="admin-box">
                <h2>Admin Login</h2>
                <input type="email" id="adminEmail" placeholder="Email Admin" value="borneomossox@gmail.com" />
                <input type="password" id="adminPassword" placeholder="Password Admin" value="Banjar2025" />
                <button onclick="adminLogin()">Login</button>
                <button onclick="hideAdminPanel()" style="margin-top: 10px; background-color: #dc3545;">Kembali ke Dashboard</button>
            </div>

            <div id="adminDashboard" class="admin-box">
                <h2>Admin Dashboard</h2>
                <p>Selamat datang, <b id="adminEmailDisplay"></b>! <button onclick="adminLogout()" style="float: right; width: auto; padding: 5px 10px;">Logout</button></p>
                <button onclick="hideAdminPanel()" style="margin-top: 10px; background-color: #dc3545;">Kembali ke Dashboard</button>

                <div class="admin-box">
                    <h3>Buat Voucher Referral Baru</h3>
                    <p>Voucher ini digunakan user untuk mengaktifkan bonus referral dan downline. Anda harus memasukkan
                        username (kode referral) dari upline yang akan menerima bonus dari user yang menggunakan voucher
                        ini. Jika tidak ada upline yang spesifik, kosongkan bidang ini.</p>
                    <input type="text" id="referralVoucherCode"
                        placeholder="Kode Voucher Referral (kosongkan untuk otomatis)" />
                    <input type="text" id="referralUplineCode"
                        placeholder="Kode Referral Upline (username upline, opsional)" />
                    <label for="referralVoucherCount"
                        style="display: block; margin-top: 10px; color: #0ff;">Jumlah Voucher Dibuat:</label>
                    <select id="referralVoucherCount" style="width: calc(100% - 20px);">
                        <option value="1">1</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="1000">1000</option>
                    </select>
                    <button onclick="createMultipleReferralVouchers()">Buat Voucher Referral</button>
                    <p id="referralVoucherMessage" style="margin-top: 10px;"></p>
                </div>

                <div class="admin-box">
                    <h3>Buat Voucher Penarikan Baru</h3>
                    <p>Voucher ini digunakan user saat mengajukan penarikan Mosso X. Setiap voucher hanya bisa digunakan
                        sekali.</p>
                    <input type="text" id="withdrawalVoucherCode"
                        placeholder="Kode Voucher Penarikan (kosongkan untuk otomatis)" />
                    <label for="withdrawalVoucherCount"
                        style="display: block; margin-top: 10px; color: #0ff;">Jumlah Voucher Dibuat:</label>
                    <select id="withdrawalVoucherCount" style="width: calc(100% - 20px);">
                        <option value="1">1</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="1000">1000</option>
                    </select>
                    <button onclick="createMultipleWithdrawalVouchers()">Buat Voucher Penarikan</button>
                    <p id="withdrawalVoucherMessage" style="margin-top: 10px;"></p>
                </div>

                <div class="admin-box">
                    <h3>Daftar Voucher Referral</h3>
                    <div id="referralVoucherList">Memuat...</div>
                </div>

                <div class="admin-box">
                    <h3>Daftar Voucher Penarikan</h3>
                    <div id="withdrawalVoucherList">Memuat...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="level2Modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('level2Modal')">&times;</span>
            <h4 id="modalTitle" style="color: #00ff62; text-align: center; margin-bottom: 15px;">Downline Level 2 dari: <span id="currentUplineUsername"></span></h4>
            <ul id="level2DownlineList">
                </ul>
            <p id="noLevel2Message" style="text-align: center; color: #ffcc00; display: none;">Tidak ada downline Level 2 untuk upline ini.</p>
        </div>
    </div>

    <div id="downlineNetworkModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('downlineNetworkModal')">&times;</span>
            <h4 style="color: #00ff62; text-align: center; margin-bottom: 15px;">Jaringan Downline Anda</h4>
            <p style="text-align: right; color: #ffcc00;">Total Bonus Jaringan: <span id="totalNetworkBonusModal">0.00000</span></p>
            <div id="downlineListModal" style="max-height: 400px; overflow-y: auto;">
                </div>
        </div>
    </div>

    <div id="bonusHistoryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('bonusHistoryModal')">&times;</span>
            <h4 style="color: #00ff62; text-align: center; margin-bottom: 15px;">Riwayat Bonus</h4>
            <div id="bonusHistoryListModal" style="max-height: 400px; overflow-y: auto;">
                </div>
        </div>
    </div>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCorYuBtoGM_ooHSz5nuCyisCIHPw6zbcA",
            authDomain: "cari-jodoh-3619a.firebaseapp.com",
            databaseURL: "https://cari-jodoh-3619a.firebaseio.com",
            projectId: "cari-jodoh-3619a",
            storageBucket: "cari-jodoh-3619a.firebasestorage.app",
            messagingSenderId: "820175894081",
            appId: "1:820175894081:web:4062ec62e430da8f8bb8c0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // KONSTANTA BONUS
        const BONUS_CHAT_SELF = 0.03;
        const MAX_DAILY_CHAT_BONUS_SELF = 0.2; // Batasan bonus chat harian untuk diri sendiri

        const BONUS_CHAT_UPLINE_1 = 0.015;
        const BONUS_CHAT_UPLINE_2 = 0.007;
        const MAX_DAILY_CHAT_BONUS_UPLINE = 3; // Batasan bonus chat harian untuk upline dari referral

        const BONUS_REFERRAL_LEVEL_1 = 0.5;
        const BONUS_REFERRAL_LEVEL_2 = 0.25;

        const WITHDRAW_BONUS_PERCENTAGE_UPLINE_1 = 0.005;
        const WITHDRAW_BONUS_PERCENTAGE_UPLINE_2 = 0.0025;

        // BATAS PENARIKAN UNTUK NONAKTIFKAN REFERRAL
        const WITHDRAW_THRESHOLD_FOR_REFERRAL_DEACTIVATION = 100;

        // Kredensial Admin (HARAP UBAH ATAU GUNAKAN MEKANISME ROLE BERBASIS DATABASE DI PRODUKSI!)
        const ADMIN_EMAIL = "borneomossox@gmail.com";
        const ADMIN_PASSWORD = "Banjar2025"; // Ini hanya untuk demo login di HTML

        let isAdminLoggedIn = false; // Flag untuk status login admin di sesi saat ini

        // Format angka ke format mata uang (misalnya, dengan 5 desimal)
        function formatBonusAmount(amount) {
            if (typeof amount !== 'number') return '0.00000';
            return amount.toFixed(5);
        }

        function toggleView(view) {
            document.getElementById('loginSection').style.display = (view === 'login') ? 'block' : 'none';
            document.getElementById('registerSection').style.display = (view === 'register') ? 'block' : 'none';
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
        }

        function register() {
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPassword').value;
            const username = document.getElementById('regUsername').value.trim();
            const refCode = document.getElementById('regRefCode').value.trim();

            if (!username) return alert("Username wajib diisi!");

            db.ref("referralCodes").orderByValue().equalTo(username).once("value").then(snap => {
                if (snap.exists()) {
                    alert("Username ini sudah digunakan. Silakan pilih username lain.");
                    return;
                }

                if (refCode) {
                    db.ref("referralCodes/" + refCode).once("value").then(refSnap => {
                        if (!refSnap.exists()) {
                            alert("Kode Referral tidak valid. Silakan cek kembali.");
                            return;
                        }
                        performRegistration(email, pass, username, refCode);
                    }).catch(err => alert(err.message));
                } else {
                    performRegistration(email, pass, username, null);
                }
            }).catch(err => alert(err.message));
        }

        function performRegistration(email, pass, username, refCode) {
            auth.createUserWithEmailAndPassword(email, pass)
                .then(cred => {
                    const uid = cred.user.uid;

                    db.ref("users/" + uid).set({
                        email,
                        username,
                        referralCode: username,
                        uplineCode: refCode || null,
                        points: 0,
                        level: 1,
                        isReferralActive: false,
                        totalWithdrawnAmount: 0, // Inisialisasi total penarikan
                        dailyChatBonusSelf: 0,
                        lastBonusDateSelf: ''
                    });
                    db.ref("referralCodes/" + username).set(uid);
                    alert("Pendaftaran berhasil! Silakan login. Untuk mengaktifkan semua bonus, Anda perlu memasukkan voucher.");

                })
                .catch(err => alert(err.message));
        }


        // Fungsi untuk mendistribusikan bonus
        // type: "Referral Activation", "Chat Bonus", "Withdrawal Bonus"
        async function distributeBonus(targetUid, bonusAmount, fromUsername, level, bonusType) {
            if (!targetUid || bonusAmount <= 0) return;

            try {
                const snap = await db.ref("users/" + targetUid).once("value");
                const userData = snap.val();

                // Pastikan user penerima bonus ada dan referralnya aktif
                if (userData && userData.isReferralActive) {
                    let currentPoints = userData.points || 0;

                    // --- Logika Batasan Bonus Chat Referral Harian DIMULAI ---
                    const today = new Date().toLocaleDateString('id-ID'); // Format tanggal yang konsisten
                    let dailyReferralChatBonus = userData.dailyReferralChatBonus || 0;
                    let lastReferralBonusDate = userData.lastReferralBonusDate || '';

                    // Reset bonus harian jika sudah hari yang berbeda
                    if (lastReferralBonusDate !== today) {
                        dailyReferralChatBonus = 0;
                        lastReferralBonusDate = today;
                    }

                    // Hanya terapkan batasan jika bonusType adalah "Chat Bonus"
                    if (bonusType === "Chat Bonus") {
                        if (dailyReferralChatBonus + bonusAmount > MAX_DAILY_CHAT_BONUS_UPLINE) {
                            console.log(`Bonus chat referral untuk ${targetUid} dari ${fromUsername} dilewati: telah mencapai batas harian (${MAX_DAILY_CHAT_BONUS_UPLINE.toFixed(5)}).`);
                            // Opsional: Anda bisa menambahkan cara untuk memberitahu upline bahwa mereka tidak menerima bonus karena batas
                            return; // Hentikan distribusi jika batas tercapai
                        }
                        dailyReferralChatBonus += bonusAmount; // Tambahkan ke total bonus harian referral
                    }
                    // --- Logika Batasan Bonus Chat Referral Harian BERAKHIR ---

                    const newPoints = currentPoints + bonusAmount;

                    // Update points, dailyReferralChatBonus, dan lastReferralBonusDate di Firebase
                    const updates = {
                        points: newPoints
                    };
                    if (bonusType === "Chat Bonus") {
                        updates.dailyReferralChatBonus = dailyReferralChatBonus;
                        updates.lastReferralBonusDate = lastReferralBonusDate;
                    }

                    // Tambahkan entri ke koleksi bonus di bawah user penerima
                    const bonusEntry = {
                        amount: bonusAmount,
                        fromUid: fromUsername, // Ini sebenarnya UID downline yang memicu bonus
                        fromUsername: fromUsername,
                        type: bonusType === "Referral Activation" ? `referral_level${level}` : (bonusType === "Chat Bonus" ? `chat_level${level}` : `withdrawal_level${level}`),
                        createdAt: Date.now()
                    };
                    await db.ref(`users/${targetUid}/bonuses`).push(bonusEntry);


                    await db.ref("users/" + targetUid).update(updates);

                    const bonusRef = db.ref("bonusHistory/" + targetUid).push();
                    await bonusRef.set({
                        date: new Date().toLocaleDateString('id-ID'),
                        amount: bonusAmount,
                        from: fromUsername,
                        level: level,
                        type: bonusType
                    });
                } else {
                    console.log(`Bonus for ${targetUid} (${bonusType}) skipped: user not found or referral not active.`);
                }
            } catch (err) {
                console.error(`Error distributing bonus to ${targetUid}:`, err);
            }
        }

        function logout() {
            auth.signOut();
            isAdminLoggedIn = false; // Reset admin flag
            // Ensure main user interface is shown after logout
            document.getElementById('userInterface').style.display = 'block';
            document.getElementById('adminPanelSection').style.display = 'none';
        }

        function showAdminPanel() {
            // Hanya izinkan admin yang sudah login untuk melihat panel admin
            if (isAdminLoggedIn) {
                document.getElementById('userInterface').style.display = 'none';
                document.getElementById('adminPanelSection').style.display = 'block';
                // Jika sudah login sebagai admin, langsung tampilkan dashboard admin
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadReferralVouchers();
                loadWithdrawalVouchers();
            } else {
                // Jika user mencoba masuk admin panel tapi belum login sebagai admin
                document.getElementById('userInterface').style.display = 'none';
                document.getElementById('adminPanelSection').style.display = 'block';
                document.getElementById('adminLoginSection').style.display = 'block'; // Tampilkan form login admin
                document.getElementById('adminDashboard').style.display = 'none';
            }
        }

        function hideAdminPanel() {
            document.getElementById('userInterface').style.display = 'block';
            document.getElementById('adminPanelSection').style.display = 'none';
        }


        auth.onAuthStateChanged(user => {
            const adminPanelLink = document.getElementById('adminPanelLink');

            if (user) {
                // Check if the logged-in user is the admin
                if (user.email === ADMIN_EMAIL) {
                    isAdminLoggedIn = true;
                    // For admin, hide user login/register, show dashboard with admin link
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('registerSection').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    adminPanelLink.style.display = 'block'; // Show admin link
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('usernameDisplay').textContent = "Admin"; // Display Admin name for clarity
                    // No need to load user specific data if directly showing admin panel on admin login
                    // but keeping it for consistency if admin also has a regular user profile
                } else {
                    isAdminLoggedIn = false;
                    // For regular users
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('registerSection').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    adminPanelLink.style.display = 'none'; // Hide admin link
                    document.getElementById('userEmail').textContent = user.email;

                    const uid = user.uid;
                    const userRef = db.ref("users/" + uid);
                    userRef.on("value", snap => {
                        const data = snap.val();
                        if (data) {
                            document.getElementById("myPoints").textContent = (data.points || 0).toFixed(5);
                            document.getElementById("usernameDisplay").textContent = data.username || "Pengguna";

                            const referralStatusElement = document.getElementById("referralStatus");
                            if (data.isReferralActive) {
                                referralStatusElement.textContent = "AKTIF";
                                referralStatusElement.style.color = "#00ff62";
                                referralStatusElement.style.textShadow = "0 0 5px #00ff62, 0 0 10px #00ff62";
                            } else {
                                referralStatusElement.textContent = "BELUM AKTIF";
                                referralStatusElement.style.color = "yellow";
                                referralStatusElement.style.textShadow = "0 0 5px yellow, 0 0 10px yellow";
                            }

                            if (data.isReferralActive) {
                                document.getElementById('referralStatusWarning').style.display = 'none';
                            } else {
                                document.getElementById('referralStatusWarning').style.display = 'block';
                            }
                        }
                    });

                    db.ref("chat").off();
                    db.ref("chat").on("child_added", snap => {
                        const msg = snap.val();
                        if (msg) addChatMessage(msg);
                    });
                }
                // Ensure admin panel sections are correctly hidden/shown based on direct admin login status
                if (!isAdminLoggedIn) {
                    document.getElementById('adminPanelSection').style.display = 'none';
                }
            } else {
                isAdminLoggedIn = false; // User logged out
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('registerSection').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                adminPanelLink.style.display = 'none'; // Hide admin link on logout
                document.getElementById('adminPanelSection').style.display = 'none'; // Hide admin panel sections
            }
        });

        function addChatMessage(msg) {
            const chatBox = document.getElementById("chatBox");

            // Create a wrapper for the username and message bubble
            const wrapperDiv = document.createElement("div");
            wrapperDiv.classList.add("message-wrapper");

            // Create the username element
            const usernameSpan = document.createElement("span");
            usernameSpan.classList.add("username-label");
            usernameSpan.textContent = msg.username + ":";

            // Create the message bubble element
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("chat-message");
            messageDiv.textContent = msg.text;

            if (auth.currentUser && msg.uid === auth.currentUser.uid) {
                wrapperDiv.classList.add("self"); // For alignment of the wrapper
                messageDiv.classList.add("self-bubble"); // For bubble styling
            } else {
                wrapperDiv.classList.add("other"); // For alignment of the wrapper
                messageDiv.classList.add("other-bubble"); // For bubble styling
            }

            // Append username and message bubble to the wrapper
            // For both self and other messages, username is appended first, then the message bubble.
            // The alignment (left/right) is controlled by the .message-wrapper.self/other flex properties.
            wrapperDiv.appendChild(usernameSpan);
            wrapperDiv.appendChild(messageDiv);


            chatBox.appendChild(wrapperDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const msgInput = document.getElementById("messageInput");
            const text = msgInput.value.trim();
            if (!text) return;

            const user = auth.currentUser;
            if (!user) {
                alert("Silakan login dulu");
                return;
            }

            try {
                const userSnap = await db.ref("users/" + user.uid).once("value");
                const userData = userSnap.val();
                let currentPoints = userData?.points || 0;
                const username = userData?.username || "User";
                const uplineCode = userData?.uplineCode || null;
                const isReferralActive = userData?.isReferralActive || false;

                // --- Logika Batasan Bonus Chat Harian Diri Sendiri ---
                const today = new Date().toLocaleDateString('id-ID');
                let dailyChatBonusSelf = userData.dailyChatBonusSelf || 0; // Ubah nama variabel agar tidak konflik
                let lastBonusDateSelf = userData.lastBonusDateSelf || ''; // Ubah nama variabel agar tidak konflik

                if (lastBonusDateSelf !== today) {
                    dailyChatBonusSelf = 0;
                    lastBonusDateSelf = today;
                }

                if (dailyChatBonusSelf + BONUS_CHAT_SELF > MAX_DAILY_CHAT_BONUS_SELF) {
                    alert(`Anda telah mencapai batas maksimal bonus chat harian untuk diri sendiri (${MAX_DAILY_CHAT_BONUS_SELF.toFixed(5)} Mosso X). Coba lagi besok.`);
                    msgInput.value = "";
                    return;
                }
                // --- Logika Batasan Bonus Chat Harian Diri Sendiri Berakhir ---

                const chatRef = db.ref("chat").push();
                await chatRef.set({
                    uid: user.uid,
                    username,
                    text,
                    timestamp: Date.now()
                });

                const newPointsSender = currentPoints + BONUS_CHAT_SELF;
                dailyChatBonusSelf += BONUS_CHAT_SELF;

                // Update points, dailyChatBonusSelf, dan lastBonusDateSelf di Firebase
                await db.ref("users/" + user.uid).update({
                    points: newPointsSender,
                    dailyChatBonusSelf: dailyChatBonusSelf,
                    lastBonusDateSelf: lastBonusDateSelf
                });

                document.getElementById("myPoints").textContent = newPointsSender.toFixed(5);

                msgInput.value = "";

                // Distribusi bonus ke upline (akan menggunakan logika batasan di distributeBonus)
                if (uplineCode && isReferralActive) {
                    const snapUpline1 = await db.ref("referralCodes/" + uplineCode).once("value");
                    const upline1Id = snapUpline1.val();
                    if (upline1Id) {
                        await distributeBonus(upline1Id, BONUS_CHAT_UPLINE_1, username, 1, "Chat Bonus");

                        const snapUpline1Data = await db.ref("users/" + upline1Id).once("value");
                        const upline1Data = snapUpline1Data.val();
                        if (upline1Data && upline1Data.uplineCode) {
                            const snapUpline2Id = await db.ref("referralCodes/" + upline1Data.uplineCode).once("value");
                            const upline2Id = snapUpline2Id.val();
                            if (upline2Id) {
                                await distributeBonus(upline2Id, BONUS_CHAT_UPLINE_2, username, 2, "Chat Bonus");
                            }
                        }
                    }
                }
            } catch (err) {
                alert("Error saat mengirim pesan atau mendistribusikan bonus chat: " + err.message);
                console.error(err);
            }
        }

        // Global function to show any modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        // Global function to close any modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showWithdrawalModal() {
            const withdrawModalContent = document.getElementById('withdrawModalContent');
            if (withdrawModalContent.style.display === 'none' || withdrawModalContent.style.display === '') {
                withdrawModalContent.style.display = 'block';
            } else {
                withdrawModalContent.style.display = 'none';
            }
        }

        async function requestWithdraw() {
            const nama = document.getElementById('withdrawName').value.trim();
            const username = document.getElementById('withdrawUser').value.trim();
            const wallet = document.getElementById('withdrawWallet').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value.trim());
            const withdrawVoucherCode = document.getElementById('withdrawVoucher').value.trim();
            const warningEl = document.getElementById('withdrawWarning');

            if (!nama || !username || !wallet || isNaN(amount) || amount <= 0 || !withdrawVoucherCode) {
                alert("Isi semua data penarikan dengan benar, termasuk Kode Voucher Penarikan.");
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                alert("Silakan login dulu.");
                return;
            }

            try {
                const userSnap = await db.ref("users/" + user.uid).once("value");
                const userData = userSnap.val();
                let currentPoints = userData?.points || 0;
                const downlineUsername = userData?.username || "Downline";
                const downlineUplineCode = userData?.uplineCode || null;
                const isDownlineReferralActive = userData?.isReferralActive || false;
                // Ambil totalWithdrawnAmount yang sudah ada, default ke 0 jika belum ada
                let totalWithdrawnAmount = userData?.totalWithdrawnAmount || 0;


                if (!isDownlineReferralActive) {
                    alert("Status referral Anda belum aktif. Anda perlu mengaktifkan referral Anda dengan voucher admin untuk bisa melakukan penarikan.");
                    return;
                }

                if (amount > currentPoints) {
                    alert("Jumlah penarikan melebihi jumlah Mosso X Anda.");
                    return;
                }
                if (amount < 50) {
                    warningEl.style.display = 'block';
                    warningEl.textContent = "⚠️ Jumlah penarikan minimal 50 Mosso X.";
                    return;
                } else {
                    warningEl.style.display = 'none';
                }

                const voucherSnap = await db.ref("withdrawalVouchers/" + withdrawVoucherCode).once("value");
                const voucherData = voucherSnap.val();

                if (!voucherData) {
                    alert("Kode Voucher Penarikan tidak valid atau tidak ditemukan.");
                    return;
                }

                if (voucherData.isUsed) {
                    alert("Kode Voucher Penarikan sudah terpakai.");
                    return;
                }

                await db.ref("withdrawalVouchers/" + withdrawVoucherCode).update({
                    isUsed: true,
                    usedByUid: user.uid,
                    usedAt: Date.now(),
                    amountRequested: amount
                });

                const email = user.email;
                const text = `*Permintaan Penarikan*\nNama: ${nama}\nUsername: ${username}\nWallet: ${wallet}\nJumlah: ${amount.toFixed(5)} Mosso X\nEmail: ${email}\nMosso X Saat Ini: ${currentPoints.toFixed(5)}\nKode Voucher Penarikan: ${withdrawVoucherCode}`;
                const waUrl = `https://wa.me/6285117579009?text=${encodeURIComponent(text)}`;
                window.open(waUrl, "_blank");

                const newPointsAfterWithdrawal = currentPoints - amount;
                const newTotalWithdrawnAmount = totalWithdrawnAmount + amount;

                const updates = {
                    points: newPointsAfterWithdrawal,
                    totalWithdrawnAmount: newTotalWithdrawnAmount // Perbarui total penarikan
                };

                // Cek jika total penarikan mencapai atau melebihi 100 Mosso X
                if (newTotalWithdrawnAmount >= WITHDRAW_THRESHOLD_FOR_REFERRAL_DEACTIVATION) {
                    updates.isReferralActive = false; // Nonaktifkan status referral
                    alert(`Selamat! Anda telah mencapai batas penarikan kumulatif ${WITHDRAW_THRESHOLD_FOR_REFERRAL_DEACTIVATION} Mosso X. Status referral Anda telah dinonaktifkan. Anda perlu mengaktifkan kembali dengan voucher baru.`);
                }

                await db.ref("users/" + user.uid).update(updates); // Perbarui user data

                const withdrawRef = db.ref("withdrawHistory/" + user.uid).push();
                await withdrawRef.set({
                    nama: nama,
                    username: username,
                    wallet: wallet,
                    amount: amount,
                    timestamp: Date.now(),
                    withdrawalVoucher: withdrawVoucherCode
                });

                document.getElementById("myPoints").textContent = newPointsAfterWithdrawal.toFixed(5);
                document.getElementById('withdrawVoucher').value = '';
                alert("Permintaan penarikan berhasil diajukan. Silakan cek WhatsApp Anda.");
                document.getElementById('withdrawModalContent').style.display = 'none'; // Hide the modal content after successful withdrawal


                if (downlineUplineCode && isDownlineReferralActive) {
                    const snapUpline1 = await db.ref("referralCodes/" + downlineUplineCode).once("value");
                    const upline1Id = snapUpline1.val();

                    if (upline1Id) {
                        const bonusUpline1 = amount * WITHDRAW_BONUS_PERCENTAGE_UPLINE_1;
                        await distributeBonus(upline1Id, bonusUpline1, downlineUsername, 1, "Withdrawal Bonus");

                        const snapUpline1Data = await db.ref("users/" + upline1Id).once("value");
                        const upline1Data = snapUpline1Data.val();

                        if (upline1Data && upline1Data.uplineCode) {
                            const snapUpline2Id = await db.ref("referralCodes/" + upline1Data.uplineCode).once("value");
                            const upline2Id = snapUpline2Id.val();
                            if (upline2Id) {
                                const bonusUpline2 = amount * WITHDRAW_BONUS_PERCENTAGE_UPLINE_2;
                                await distributeBonus(upline2Id, bonusUpline2, downlineUsername, 2, "Withdrawal Bonus");
                            }
                        }
                    }
                }

            } catch (err) {
                alert("Error saat mengajukan penarikan atau mendistribusikan bonus: " + err.message);
                console.error(err);
            }
        }

        async function useVoucher() {
            const voucherCode = document.getElementById('voucherCode').value.trim();
            const voucherMessageEl = document.getElementById('voucherMessage');
            voucherMessageEl.style.display = 'none';
            voucherMessageEl.textContent = '';

            if (!voucherCode) {
                voucherMessageEl.style.display = 'block';
                voucherMessageEl.textContent = "⚠️ Masukkan kode voucher terlebih dahulu.";
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                alert("Silakan login dulu untuk menggunakan voucher.");
                return;
            }

            try {
                const userRef = db.ref("users/" + user.uid);
                const userSnap = await userRef.once("value");
                const userData = userSnap.val();

                // Hanya cek isReferralActive di sini, karena voucher sekarang bisa mengaktifkan kembali
                // if (userData && userData.isReferralActive) {
                //     voucherMessageEl.style.display = 'block';
                //     voucherMessageEl.textContent = "⚠️ Status referral Anda sudah aktif.";
                //     return;
                // }

                const snap = await db.ref("vouchers/" + voucherCode).once("value");
                const voucherData = snap.val();

                if (!voucherData) {
                    voucherMessageEl.style.display = 'block';
                    voucherMessageEl.textContent = "⚠️ Kode voucher tidak valid atau tidak ditemukan.";
                    return;
                }

                if (voucherData.isUsed) {
                    voucherMessageEl.style.display = 'block';
                    voucherMessageEl.textContent = "⚠️ Kode voucher sudah terpakai.";
                    return;
                }

                const uplineCodeFromVoucher = voucherData.uplineCode;

                await db.ref("vouchers/" + voucherCode).update({
                    isUsed: true,
                    usedByUid: user.uid,
                    usedAt: Date.now()
                });

                const updates = {
                    isReferralActive: true
                };

                let finalUplineCode = userData.uplineCode;
                if (!userData.uplineCode && uplineCodeFromVoucher) {
                    updates.uplineCode = uplineCodeFromVoucher;
                    finalUplineCode = uplineCodeFromVoucher;
                } else if (userData.uplineCode && uplineCodeFromVoucher && userData.uplineCode !== uplineCodeFromVoucher) {
                    // Ini adalah skenario di mana pengguna sudah punya upline dari pendaftaran,
                    // dan voucher juga punya upline. Biarkan upline yang sudah ada.
                    // Pesan ini hanya untuk informasi kepada pengguna
                    voucherMessageEl.style.display = 'block';
                    voucherMessageEl.textContent = "⚠️ Anda sudah memiliki upline referral dari pendaftaran. Voucher ini hanya mengaktifkan bonus Anda. Upline tidak diubah. (Lanjutkan)";
                    console.warn("User already has an upline from registration, not changing it with voucher.");
                }

                await userRef.update(updates);
                const currentUsername = userData.username || 'Pengguna Baru';

                // Logika distribusi bonus referral saat aktivasi
                if (finalUplineCode) {
                    const snapUplineId = await db.ref("referralCodes/" + finalUplineCode).once("value");
                    const upline1Uid = snapUplineId.val();
                    if (upline1Uid) {
                        // Pastikan downline dicatat hanya sekali di daftar downline upline
                        await db.ref("users/" + upline1Uid + "/downlines/" + user.uid).set({
                            username: currentUsername,
                            level: 1,
                            uid: user.uid,
                            isActivated: true // Tandai downline sudah aktif
                        });

                        await distributeBonus(upline1Uid, BONUS_REFERRAL_LEVEL_1, currentUsername, 1, "Referral Activation");

                        const snapUpline1Data = await db.ref("users/" + upline1Uid).once("value");
                        const upline1DataFromVoucher = snapUpline1Data.val();
                        if (upline1DataFromVoucher && upline1DataFromVoucher.uplineCode) {
                            const snapUpline2Id = await db.ref("referralCodes/" + upline1DataFromVoucher.uplineCode).once("value");
                            const upline2Uid = snapUpline2Id.val();
                            if (upline2Uid) {
                                // Pastikan downline dicatat hanya sekali di daftar downline upline level 2
                                await db.ref("users/" + upline2Uid + "/downlines/" + user.uid).set({
                                    username: currentUsername,
                                    level: 2,
                                    uid: user.uid,
                                    isActivated: true // Tandai downline sudah aktif
                                });
                                await distributeBonus(upline2Uid, BONUS_REFERRAL_LEVEL_2, currentUsername, 2, "Referral Activation");
                            }
                        }
                    }
                }

                voucherMessageEl.style.display = 'block';
                voucherMessageEl.className = 'blink-warning success';
                voucherMessageEl.textContent = `Voucher berhasil digunakan! Status referral Anda sekarang AKTIF. Anda dapat mulai menerima bonus dan melakukan penarikan.`;
                document.getElementById('voucherCode').value = '';

                // Re-load downlines and bonus history to update status
                const currentAuthUser = auth.currentUser;
                if (currentAuthUser) {
                    loadDownlines(currentAuthUser.uid);
                    loadBonusHistory(currentAuthUser.uid);
                }
                
                document.getElementById('referralStatusWarning').style.display = 'none';

            } catch (err) {
                voucherMessageEl.style.display = 'block';
                voucherMessageEl.textContent = `Error: ${err.message}`;
                console.error("Error in useVoucher:", err);
            }
        }

        async function showDownlineModal() {
            const user = auth.currentUser;
            if (!user) {
                alert("Silakan login dulu.");
                return;
            }
            showModal('downlineNetworkModal');
            loadDownlines(user.uid);
        }

        async function loadDownlines(myUid) {
            const downlineContainer = document.getElementById('downlineListModal');
            const totalNetworkBonusSpan = document.getElementById('totalNetworkBonusModal'); 

            if (!downlineContainer) return;
            downlineContainer.innerHTML = ''; 

            const loadingIndicator = document.createElement('p');
            loadingIndicator.textContent = "Memuat data downline dan bonus...";
            loadingIndicator.style.color = '#0ff';
            loadingIndicator.style.textAlign = 'center';
            downlineContainer.appendChild(loadingIndicator);

            try {
                const [usersSnapshot, myBonusesSnapshot] = await Promise.all([
                    db.ref('users').once('value'),
                    db.ref(`users/${myUid}/bonuses`).once('value') 
                ]);

                const users = usersSnapshot.val();
                const myBonuses = myBonusesSnapshot.val() || {}; 

                if (!users) {
                    downlineContainer.textContent = "Tidak ada data pengguna.";
                    if(totalNetworkBonusSpan) totalNetworkBonusSpan.textContent = formatBonusAmount(0);
                    return;
                }

                const myUser = users[myUid];
                if (!myUser || !myUser.referralCode) {
                    downlineContainer.textContent = "Data pengguna Anda tidak lengkap.";
                    if(totalNetworkBonusSpan) totalNetworkBonusSpan.textContent = formatBonusAmount(0);
                    return;
                }

                const myReferralCode = myUser.referralCode;

                const level1Downlines = [];
                const level2DownlinesMap = {}; 
                const level1BonusMap = {};    
                const level2BonusMap = {};    

                // Inisialisasi peta bonus dan hitung total bonus per downline
                let currentTotalNetworkBonus = 0;
                for (const bonusId in myBonuses) {
                    const bonus = myBonuses[bonusId];
                    if (bonus.amount && bonus.fromUid) {
                        currentTotalNetworkBonus += bonus.amount; 
                        // Pastikan fromUid ada di peta, jika tidak, inisialisasi
                        if (level1BonusMap[bonus.fromUid] === undefined) level1BonusMap[bonus.fromUid] = 0;
                        if (level2BonusMap[bonus.fromUid] === undefined) level2BonusMap[bonus.fromUid] = 0;

                        if (bonus.type === 'referral_level1' || bonus.type === 'chat_level1' || bonus.type === 'withdrawal_level1') {
                            level1BonusMap[bonus.fromUid] += bonus.amount;
                        } else if (bonus.type === 'referral_level2' || bonus.type === 'chat_level2' || bonus.type === 'withdrawal_level2') {
                            level2BonusMap[bonus.fromUid] += bonus.amount;
                        }
                    }
                }
                if(totalNetworkBonusSpan) totalNetworkBonusSpan.textContent = formatBonusAmount(currentTotalNetworkBonus);

                // Kumpulkan semua downline Level 1 terlebih dahulu
                for (const uid in users) {
                    const user = users[uid];
                    if (user.uplineCode === myReferralCode) {
                        level1Downlines.push({ 
                            uid: uid, 
                            username: user.username, 
                            referralCode: user.referralCode || '',
                            totalBonusFromThisDownline: level1BonusMap[uid] || 0, // Dapatkan bonus dari map
                            isActivated: user.isReferralActive || false // Status aktivasi
                        });
                        level2DownlinesMap[user.referralCode] = []; // Inisialisasi array untuk Level 2 dari downline ini
                    }
                }
                
                // Kumpulkan semua downline Level 2 dan tambahkan bonusnya ke map level2DownlinesMap
                for (const uid in users) {
                    const user = users[uid];
                    // Cek apakah uplineCode user ini cocok dengan referralCode dari Level 1 downline
                    for (const level1D of level1Downlines) {
                        if (user.uplineCode === level1D.referralCode) {
                            if (level2DownlinesMap[level1D.referralCode]) {
                                level2DownlinesMap[level1D.referralCode].push({ 
                                    uid: uid, 
                                    username: user.username,
                                    totalBonusFromThisDownline: level2BonusMap[uid] || 0, // Dapatkan bonus dari map
                                    isActivated: user.isReferralActive || false // Status aktivasi
                                });
                            }
                            break; 
                        }
                    }
                }

                downlineContainer.innerHTML = ''; 

                if (level1Downlines.length === 0) {
                    downlineContainer.textContent = "Anda belum memiliki jaringan downline Level 1.";
                    return;
                }

                const ul = document.createElement('ul');
                ul.classList.add('downline-list-container'); 
                
                // Batasi tampilan Level 1 menjadi maksimal 10
                const displayLimitLevel1 = 10;
                const level1ToDisplay = level1Downlines.slice(0, displayLimitLevel1);

                level1ToDisplay.forEach(level1D => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="downline-info">
                            <span>${level1D.username} (Level 1)</span>
                            <span class="view-level2-link" data-referral-code="${level1D.referralCode}" data-username="${level1D.username}">
                                (Lihat Downline Level 2)
                            </span>
                        </div>
                    `;
                    ul.appendChild(li);
                });

                if (level1Downlines.length > displayLimitLevel1) {
                    const moreLi = document.createElement('li');
                    moreLi.style.textAlign = 'center';
                    moreLi.style.fontStyle = 'italic';
                    moreLi.textContent = `... dan ${level1Downlines.length - displayLimitLevel1} downline Level 1 lainnya.`;
                    ul.appendChild(moreLi);
                }

                downlineContainer.appendChild(ul);

                downlineContainer.addEventListener('click', function(event) {
                    if (event.target.classList.contains('view-level2-link')) {
                        const referralCode = event.target.dataset.referralCode;
                        const uplineUsername = event.target.dataset.username;
                        showLevel2DownlinesModal(referralCode, uplineUsername, level2DownlinesMap);
                    }
                });

            } catch (error) {
                console.error("Error loading downlines:", error);
                downlineContainer.textContent = "Terjadi kesalahan saat memuat downline.";
                if(totalNetworkBonusSpan) totalNetworkBonusSpan.textContent = formatBonusAmount(0);
            }
        }


        // --- Fungsi untuk Mengelola Pop-up Modal ---
        const level2Modal = document.getElementById('level2Modal');
        // Close button for level2Modal now uses global closeModal function
        const modalTitle = document.getElementById('modalTitle');
        const currentUplineUsernameSpan = document.getElementById('currentUplineUsername');
        const level2DownlineList = document.getElementById('level2DownlineList');
        const noLevel2Message = document.getElementById('noLevel2Message');

        function showLevel2DownlinesModal(uplineReferralCode, uplineUsername, allLevel2Data) {
            currentUplineUsernameSpan.textContent = uplineUsername;
            level2DownlineList.innerHTML = ''; 
            noLevel2Message.style.display = 'none'; 

            const level2s = allLevel2Data[uplineReferralCode] || [];

            // Hitung total bonus dari SEMUA downline Level 2 terkait upline ini
            let totalBonusFromThisLevel2Group = 0;
            level2s.forEach(downline => {
                totalBonusFromThisLevel2Group += downline.totalBonusFromThisDownline;
            });

            // Tampilkan total bonus di header modal (opsional, bisa juga di bawah daftar)
            modalTitle.innerHTML = `Downline Level 2 dari: <span id="currentUplineUsername">${uplineUsername}</span> <br> Total Bonus dari L2 ini: ${formatBonusAmount(totalBonusFromThisLevel2Group)}`;


            if (level2s.length > 0) {
                const displayLimitLevel2 = 10;
                const level2ToDisplay = level2s.slice(0, displayLimitLevel2);

                level2ToDisplay.forEach(downline => {
                    const li = document.createElement('li');
                    // Tampilkan hanya username dan status aktivasi (jika ada)
                    const activationStatus = downline.isActivated ? 'Aktif' : 'Belum Aktif';
                    li.innerHTML = `
                        <span>${downline.username}</span>
                        <span>(${activationStatus})</span>
                    `;
                    level2DownlineList.appendChild(li);
                });

                if (level2s.length > displayLimitLevel2) {
                    const moreLi = document.createElement('li');
                    moreLi.style.textAlign = 'center';
                    moreLi.style.fontStyle = 'italic';
                    moreLi.style.borderBottom = 'none'; // Jangan ada garis bawah untuk ini
                    moreLi.textContent = `... dan ${level2s.length - displayLimitLevel2} downline lainnya.`;
                    level2DownlineList.appendChild(moreLi);
                }

            } else {
                noLevel2Message.style.display = 'block'; 
            }

            level2Modal.style.display = 'flex'; 
        }

        // Tutup modal saat user mengklik di luar area modal content
        window.onclick = function(event) {
            if (event.target == level2Modal) {
                level2Modal.style.display = 'none';
            }
            if (event.target == document.getElementById('downlineNetworkModal')) {
                document.getElementById('downlineNetworkModal').style.display = 'none';
            }
            if (event.target == document.getElementById('bonusHistoryModal')) {
                document.getElementById('bonusHistoryModal').style.display = 'none';
            }
        }

        async function showBonusHistoryModal() {
            const user = auth.currentUser;
            if (!user) {
                alert("Silakan login dulu.");
                return;
            }
            showModal('bonusHistoryModal');
            loadBonusHistory(user.uid);
        }

        async function loadBonusHistory(uid) {
            const container = document.getElementById('bonusHistoryListModal');
            container.innerHTML = ""; // Clear previous content

            try {
                const [bonusSnap, usersSnap] = await Promise.all([
                    db.ref("users/" + uid + "/bonuses").once("value"),
                    db.ref("users").once("value") // Get all users to check activation status
                ]);

                const bonuses = bonusSnap.val();
                const allUsers = usersSnap.val();

                if (!bonuses) {
                    container.textContent = "Belum ada riwayat bonus.";
                    return;
                }

                const sortedBonuses = Object.values(bonuses).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                sortedBonuses.forEach(bonus => {
                    const div = document.createElement("div");
                    div.className = 'list-item';

                    // Get the fromUsername's activation status
                    let activationStatus = "Status Tidak Diketahui";
                    if (allUsers && bonus.fromUid) {
                        const fromUser = Object.values(allUsers).find(user => user.username === bonus.fromUsername);
                        if (fromUser) {
                            activationStatus = fromUser.isReferralActive ? "AKTIF" : "BELUM AKTIF";
                        }
                    }

                    div.textContent = `${new Date(bonus.createdAt).toLocaleDateString('id-ID')} - +${bonus.amount.toFixed(5)} Mosso X dari ${bonus.fromUsername} (Status Downline: ${activationStatus})`;
                    container.appendChild(div);
                });
            } catch (err) {
                console.error("Error loading bonus history:", err);
                container.textContent = "Error memuat riwayat bonus.";
            }
        }


        // ADMIN PANEL FUNCTIONS (from HTML 2)
        function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPassword').value;

            if (email === ADMIN_EMAIL && pass === ADMIN_PASSWORD) {
                auth.signInWithEmailAndPassword(email, pass)
                    .then(() => {
                        console.log("Admin logged in successfully.");
                        // Set the admin flag
                        isAdminLoggedIn = true;
                        document.getElementById('adminLoginSection').style.display = 'none';
                        document.getElementById('adminDashboard').style.display = 'block';
                        document.getElementById('adminEmailDisplay').textContent = email;
                        loadReferralVouchers();
                        loadWithdrawalVouchers();
                    })
                    .catch(err => {
                        alert("Login Gagal: " + err.message);
                        console.error(err);
                    });
            } else {
                alert("Kredensial admin tidak valid.");
            }
        }

        function adminLogout() {
            auth.signOut();
            isAdminLoggedIn = false; // Reset admin flag
            document.getElementById('adminLoginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            // Also hide the whole admin panel section and show user interface
            document.getElementById('adminPanelSection').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
        }

        // --- Fungsi untuk menghasilkan kode voucher acak ---
        function generateRandomVoucherCode(prefix) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = prefix;
            const length = 7; // Mengurangi panjang agar lebih mudah diingat, bisa diubah

            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // --- Fungsi untuk mengunduh voucher sebagai file teks ---
        function downloadVouchersAsTextFile(voucherCodes, filename) {
            const content = voucherCodes.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Fungsi untuk membuat 1 Voucher Referral (dipanggil oleh createMultipleReferralVouchers) ---
        async function createSingleReferralVoucher(voucherCodeToUse, uplineCodeInput, messageEl) {
            let voucherCode = voucherCodeToUse; // Ini bisa dari input manual atau generate
            const uplineCode = uplineCodeInput.trim();

            // Jika kode yang diterima kosong, generate otomatis
            if (!voucherCode) {
                voucherCode = generateRandomVoucherCode("MossoX_REF_");
            }

            // Validasi upline code (hanya perlu sekali per batch, tapi aman jika di sini juga)
            if (uplineCode) {
                try {
                    const uplineSnap = await db.ref("referralCodes/" + uplineCode).once("value");
                    if (!uplineSnap.exists()) {
                        messageEl.classList.add('message-error');
                        messageEl.textContent = "Kode Referral Upline tidak ditemukan sebagai username yang valid. Kosongkan jika tidak ada upline spesifik.";
                        return false; // Menghentikan pembuatan voucher ini
                    }
                } catch (error) {
                    messageEl.classList.add('message-error');
                    messageEl.textContent = "Error memvalidasi upline: " + error.message;
                    console.error("Error validating upline code:", error);
                    return false; // Menghentikan pembuatan voucher ini
                }
            }

            try {
                const voucherSnap = await db.ref("vouchers/" + voucherCode).once("value");
                if (voucherSnap.exists()) {
                    console.warn(`Duplicate voucher code generated: ${voucherCode}. Retrying...`);
                    // Jika duplikat, coba lagi dengan kode baru (rekursif)
                    // Hati-hati dengan rekursi tak terbatas jika generator kode bermasalah
                    return await createSingleReferralVoucher(generateRandomVoucherCode("MossoX_REF_"), uplineCodeInput, messageEl);
                }

                await db.ref("vouchers/" + voucherCode).set({
                    uplineCode: uplineCode || null,
                    isUsed: false,
                    createdAt: Date.now()
                });
                return voucherCode; // Mengembalikan kode voucher yang berhasil dibuat
            } catch (error) {
                messageEl.classList.add('message-error');
                messageEl.textContent = "Error membuat voucher: " + error.message; // Pesan error Firebase
                console.error("Error creating referral voucher:", error);
                return false; // Mengindikasikan kegagalan
            }
        }

        // --- Fungsi baru untuk membuat banyak voucher referral ---
        async function createMultipleReferralVouchers() {
            const voucherCodeManual = document.getElementById('referralVoucherCode').value.trim();
            const uplineCodeInput = document.getElementById('referralUplineCode').value.trim();
            const count = parseInt(document.getElementById('referralVoucherCount').value);
            const messageEl = document.getElementById('referralVoucherMessage');
            messageEl.textContent = ''; // Bersihkan pesan sebelumnya
            messageEl.className = ''; // Bersihkan kelas sebelumnya

            if (voucherCodeManual && count > 1) {
                messageEl.classList.add('message-error');
                messageEl.textContent = "Tidak bisa membuat banyak voucher dengan kode manual. Kosongkan kode untuk otomatis.";
                return;
            }

            messageEl.textContent = `Membuat ${count} voucher...`;
            let successfulCount = 0;
            let generatedCodes = [];
            let hasFatalError = false;

            for (let i = 0; i < count; i++) {
                // Gunakan kode manual untuk yang pertama, sisanya generate otomatis
                const codeToPass = (i === 0 && voucherCodeManual) ? voucherCodeManual : generateRandomVoucherCode("MossoX_REF_");

                const result = await createSingleReferralVoucher(codeToPass, uplineCodeInput, messageEl);
                if (result) {
                    successfulCount++;
                    generatedCodes.push(result);
                } else {
                    // Jika ada error fatal (misal: permission denied) atau upline tidak valid, berhenti
                    if (messageEl.classList.contains('message-error') && !messageEl.textContent.includes('sudah ada')) {
                        hasFatalError = true;
                        break; // Hentikan loop jika ada error yang bukan duplikat
                    }
                }
            }

            if (hasFatalError) {
                // Pesan error sudah diatur oleh createSingleReferralVoucher
                // Tidak perlu pesan sukses jika ada error fatal
            } else if (successfulCount > 0) {
                messageEl.classList.add('message-success');
                messageEl.textContent = `${successfulCount} Voucher Referral berhasil dibuat.`;
                if (generatedCodes.length > 0) {
                    messageEl.innerHTML += `<br>Kode-kode yang dibuat: <br><textarea rows="5" readonly>${generatedCodes.join('\n')}</textarea>`;
                    // NEW: Trigger download
                    downloadVouchersAsTextFile(generatedCodes, `MossoX_Referral_Vouchers_${new Date().toISOString().slice(0, 10)}.txt`);
                }
            } else {
                messageEl.classList.add('message-error');
                if (!messageEl.textContent) { // Hanya jika tidak ada error spesifik sebelumnya
                    messageEl.textContent = "Gagal membuat voucher. Periksa konsol browser untuk detail.";
                }
            }
            document.getElementById('referralVoucherCode').value = '';
            document.getElementById('referralUplineCode').value = '';
            loadReferralVouchers(); // Refresh daftar setelah operasi selesai
        }


        function loadReferralVouchers() {
            const container = document.getElementById('referralVoucherList');
            if (!container) return; // Add a check to ensure element exists before trying to access it
            container.innerHTML = "Memuat...";

            db.ref("vouchers").on("value", snap => {
                const vouchers = snap.val();
                container.innerHTML = "";
                if (!vouchers) {
                    container.textContent = 'Belum ada voucher referral yang dibuat.';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Kode Voucher</th>
                            <th>Upline Code</th>
                            <th>Status</th>
                            <th>Digunakan Oleh (UID)</th>
                            <th>Digunakan Pada</th>
                            <th>Dibuat Pada</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                const sortedVouchers = Object.entries(vouchers).sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));

                sortedVouchers.forEach(([code, data]) => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = code;
                    row.insertCell().textContent = data.uplineCode || '-';
                    row.insertCell().textContent = data.isUsed ? 'Terpakai' : 'Belum Terpakai';
                    row.insertCell().textContent = data.usedByUid || '-';
                    row.insertCell().textContent = data.usedAt ? new Date(data.usedAt).toLocaleString('id-ID') : '-';
                    row.insertCell().textContent = data.createdAt ? new Date(data.createdAt).toLocaleString('id-ID') : '-';
                });
                container.appendChild(table);
            }, error => {
                console.error("Error loading referral vouchers:", error);
                container.textContent = "Error memuat daftar voucher referral.";
            });
        }

        // --- Fungsi untuk membuat 1 Voucher Penarikan (dipanggil oleh createMultipleWithdrawalVouchers) ---
        async function createSingleWithdrawalVoucher(voucherCodeToUse, messageEl) {
            let voucherCode = voucherCodeToUse; // Ini bisa dari input manual atau generate

            // Jika kode yang diterima kosong, generate otomatis
            if (!voucherCode) {
                voucherCode = generateRandomVoucherCode("MossoX_WD_");
            }

            try {
                const voucherSnap = await db.ref("withdrawalVouchers/" + voucherCode).once("value");
                if (voucherSnap.exists()) {
                    console.warn(`Duplicate withdrawal voucher code generated: ${voucherCode}. Retrying...`);
                    // Jika duplikat, coba lagi dengan kode baru (rekursif)
                    return await createSingleWithdrawalVoucher(generateRandomVoucherCode("MossoX_WD_"), messageEl);
                }

                await db.ref("withdrawalVouchers/" + voucherCode).set({
                    isUsed: false,
                    createdAt: Date.now()
                });
                return voucherCode; // Mengembalikan kode voucher yang berhasil dibuat
            } catch (error) {
                messageEl.classList.add('message-error');
                messageEl.textContent = "Error membuat voucher: " + error.message;
                console.error("Error creating withdrawal voucher:", error);
                return false; // Mengindikasikan kegagalan
            }
        }

        // --- Fungsi baru untuk membuat banyak voucher penarikan ---
        async function createMultipleWithdrawalVouchers() {
            const voucherCodeManual = document.getElementById('withdrawalVoucherCode').value.trim();
            const count = parseInt(document.getElementById('withdrawalVoucherCount').value);
            const messageEl = document.getElementById('withdrawalVoucherMessage');
            messageEl.textContent = ''; // Bersihkan pesan sebelumnya
            messageEl.className = ''; // Bersihkan kelas sebelumnya

            if (voucherCodeManual && count > 1) {
                messageEl.classList.add('message-error');
                messageEl.textContent = "Tidak bisa membuat banyak voucher dengan kode manual. Kosongkan kode untuk otomatis.";
                return;
            }

            messageEl.textContent = `Membuat ${count} voucher...`;
            let successfulCount = 0;
            let generatedCodes = [];
            let hasFatalError = false;

            for (let i = 0; i < count; i++) {
                // Gunakan kode manual untuk yang pertama, sisanya generate otomatis
                const codeToPass = (i === 0 && voucherCodeManual) ? voucherCodeManual : generateRandomVoucherCode("MossoX_WD_");

                const result = await createSingleWithdrawalVoucher(codeToPass, messageEl);
                if (result) {
                    successfulCount++;
                    generatedCodes.push(result);
                } else {
                    // Jika ada error fatal (misal: permission denied), berhenti
                    if (messageEl.classList.contains('message-error') && !messageEl.textContent.includes('sudah ada')) {
                        hasFatalError = true;
                        break;
                    }
                }
            }

            if (hasFatalError) {
                // Pesan error sudah diatur oleh createSingleWithdrawalVoucher
            } else if (successfulCount > 0) {
                messageEl.classList.add('message-success');
                messageEl.textContent = `${successfulCount} Voucher Penarikan berhasil dibuat.`;
                if (generatedCodes.length > 0) {
                    messageEl.innerHTML += `<br>Kode-kode yang dibuat: <br><textarea rows="5" readonly>${generatedCodes.join('\n')}</textarea>`;
                    // NEW: Trigger download
                    downloadVouchersAsTextFile(generatedCodes, `MossoX_Withdrawal_Vouchers_${new Date().toISOString().slice(0, 10)}.txt`);
                }
            } else {
                messageEl.classList.add('message-error');
                if (!messageEl.textContent) { // Hanya jika tidak ada error spesifik sebelumnya
                    messageEl.textContent = "Gagal membuat voucher. Periksa konsol browser untuk detail.";
                }
            }
            document.getElementById('withdrawalVoucherCode').value = '';
            loadWithdrawalVouchers(); // Refresh daftar setelah operasi selesai
        }

        function loadWithdrawalVouchers() {
            const container = document.getElementById('withdrawalVoucherList');
            if (!container) return; // Add a check to ensure element exists before trying to access it
            container.innerHTML = "Memuat...";

            db.ref("withdrawalVouchers").on("value", snap => {
                const vouchers = snap.val();
                container.innerHTML = "";
                if (!vouchers) {
                    container.textContent = 'Belum ada voucher penarikan yang dibuat.';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Kode Voucher</th>
                            <th>Status</th>
                            <th>Digunakan Oleh (UID)</th>
                            <th>Jumlah Penarikan</th>
                            <th>Digunakan Pada</th>
                            <th>Dibuat Pada</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                const sortedVouchers = Object.entries(vouchers).sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));


                sortedVouchers.forEach(([code, data]) => {
                    const row = tbody.insertRow(); // Corrected: Use tbody.insertRow()
                    row.insertCell().textContent = code;
                    row.insertCell().textContent = data.isUsed ? 'Terpakai' : 'Belum Terpakai';
                    row.insertCell().textContent = data.usedByUid || '-';
                    row.insertCell().textContent = data.amountRequested !== undefined ? data.amountRequested.toFixed(5) : '-';
                    row.insertCell().textContent = data.usedAt ? new Date(data.usedAt).toLocaleString('id-ID') : '-';
                    row.insertCell().textContent = data.createdAt ? new Date(data.createdAt).toLocaleString('id-ID') : '-';
                });
                container.appendChild(table);
            }, error => {
                console.error("Error loading withdrawal vouchers:", error);
                container.textContent = "Error memuat daftar voucher penarikan.";
            });
        }
    </script>
</body>

</html>
